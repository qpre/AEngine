var AE={Assets:{},MVC:{},States:{},Workers:{}},Game={},Audio={};((function(){var a,b,c,d,e,f,g={}.hasOwnProperty,h=function(a,b){function d(){this.constructor=a}for(var c in b)g.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};AE.Singleton=function(){function a(){}return a._instance=null,a.getInstance=function(){return this._instance||(this._instance=new this)},a}(),Function.prototype.property=function(a,b){return Object.defineProperty(this.prototype,a,b)},c=function(a,b){var c;return c=new XMLHttpRequest,c.open("GET",a,!0),c.responseType="blob",c.addEventListener("loadend",function(){return c.status===200?b(c.response):AE.error("could'nt retrieve file: "+a)}),c.send(),c},f=function(a,b){var c;return c=new XMLHttpRequest,c.open("GET",a,!1),c.responseType="blob",c.send(),c.status===200?b(c.response):AE.error("could'nt retrieve file: "+a)},AE.IdFactory=function(a){function b(){this._guids=[]}return h(b,a),b.prototype._guids=null,b.prototype.has=function(a){return this._guids.indexOf(a.toString())>-1?!0:!1},b.prototype.getGUID=function(){var a;return a=this.guid(),this.has(a)?a=this.getGUID():this._guids.push(a),a},b.prototype.s4=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)},b.prototype.guid=function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()},b}(AE.Singleton),AE.Object=function(){function a(){}return a.prototype._guid=null,a.property("guid",{get:function(){return this._guid===null&&(this._guid=AE.IdFactory.getInstance().getGUID()),this._guid}}),a.prototype.init=function(){},a.create=function(){var a,b;return a=this,b=new a,arguments.length>0?b.init(arguments):b.init(),b},a}(),Audio.SubSystem=function(a){function b(a){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.context=new AudioContext}catch(b){AE.error("AE.Audio : Web Audio API not supported")}this.loadMap(a)}return h(b,a),b}(AE.Object),AE.Event=function(){function a(a){this._sender=a,this._subscribers=[]}return a.prototype._subscribers=null,a.prototype._sender=null,a.prototype.subscribe=function(a){return this._subscribers.push(a)},a.prototype.notify=function(a){var b,c,d,e;e=[];for(b=c=0,d=this._subscribers.length-1;c<=d;b=c+=1)e.push(this._subscribers[b](this._sender,a));return e},a}(),AE.Config=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.setConfig=function(a){this._opts=a;if(this._opts)return AE.log("--------------------"),this._opts.name&&AE.log("name: "+this._opts.name),this._opts.version&&AE.log("version: "+this._opts.version),AE.log("--------------------")},b}(AE.Singleton),AE.log=function(a){return console.log(a)},AE.debug=function(a){return console.debug(a)},AE.error=function(a){return console.error(a)},a=Object.freeze({ACTIVE:0,PAUSED:1}),AE.States.GamePhase=function(b){function c(a,b,c,d){this._name=a,this._in=b,this._out=c,this._run=d,this._statusChangedEvent=new AE.Event(this),this._statusChangedEvent.subscribe(this.onStatusChanged)}return h(c,b),c.prototype._status=a.PAUSED,c.prototype._statusChangedEvent=null,c.prototype.notifyStatusChanged=function(){return this._statusChangedEvent.notify({status:this._status})},c.prototype.onStatusChanged=function(a,b){},c.prototype.setActive=function(){return this._status=a.ACTIVE,this.notifyStatusChanged()},c.prototype.setUnactive=function(){return this._status=a.PAUSED,this.notifyStatusChanged()},c.prototype["in"]=function(){return this._in()},c.prototype.out=function(){return this._out()},c.prototype.run=function(){return this._run()},c}(AE.Object),AE.States.GamePhasesManager=function(a){function b(){this._phases={}}return h(b,a),b.prototype._phases=null,b.prototype._current=null,b.prototype.has=function(a){return this._phases.hasOwnProperty(a)?!0:!1},b.prototype.addPhase=function(a,b,c,d){return this.has(a)?AE.error("Phase "+a+" already exists"):this._phases[a]=new AE.States.GamePhase(a,b,c,d)},b.prototype.current=function(){return this._current},b.prototype.setCurrent=function(a){return this.has(a.toString())?(this._current=this._phases[a.toString()],this._current.setActive(),this._current["in"](),this._current.run()):AE.error("No such phase: "+a)},b.prototype.transitionTo=function(a){return this._current===null?AE.error("No current phase was set, can't transit from nowhere"):(this._current.out(),this._current.setUnactive(),this.setCurrent(a))},b}(AE.Singleton),AE.Engine=function(a){function b(a){console.log("imma new engine boy!")}return h(b,a),b}(AE.Object),self.requestFileSystem=self.requestFileSystem||self.webkitRequestFileSystem,self.requestFileSystemAsync=self.requestFileSystem||self.webkitRequestFileSystem,self.resolveLocalFileSystemURL=self.webkitResolveLocalFileSystemURL||self.resolveLocalFileSystemURL,AE.FileSystem=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype._isCreated=null,b.prototype._stack=[],b.prototype.createFileSystem=function(a){return this._isCreated===null&&(requestFileSystem(TEMPORARY,10485760,function(a){AE.FileSystem.getInstance().onInitFS(a)},function(a){AE.FileSystem.getInstance().onErrorFSHandler(a)}),this._isCreated=!1),this._stack.push(a)},b.prototype.writeFile=function(a,b,c){var d=this;return this._filesystem?this._filesystem.root.getFile(a,{create:!0},function(a){return a.createWriter(function(a){var d;return a.onerror=function(a){return console.error(a)},c&&(a.onwrite=c),d=new Blob([b]),a.write(d)})}):this.createFileSystem(function(){return d.writeFile(a,b,c)})},b.prototype.readFile=function(a,b){var c=this;return this._filesystem?this._filesystem.root.getFile(a,{},function(a){return a.file(function(a){var c;return c=new FileReader,b&&(c.onloadend=function(){return b(c.result)}),c.readAsText(a)})}):this.createFileSystem(function(){return c.readFile(a,b)})},b.prototype.readBuffer=function(a,b){var c=this;return this._filesystem?this._filesystem.root.getFile(a,{},function(a){return a.file(function(a){var c;return c=new FileReader,b&&(c.onloadend=function(){return b(c.result)}),c.readAsArrayBuffer(a)})}):this.createFileSystem(function(){return c.readBuffer(a,b)})},b.prototype.onInitFS=function(a){var b,c,d,e;this._filesystem=a,this._isCreated=!0,e=this._stack;for(c=0,d=e.length;c<d;c++)b=e[c],b.call();return this._stack=[]},b.prototype.onErrorFSHandler=function(a){var b;switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}return AE.error("AE.FILESYSTEM failed with "+b)},b}(AE.Singleton),AE.Assets.URLLoader=function(a){function b(a,b,c){this._fileURL=a,this._onSuccess=b,this._filepath=c,this._filepath||(this._filepath=this.guid),this.guid}return h(b,a),b.prototype.isReady=!1,b.prototype._fileURL=null,b.prototype._file=null,b.prototype.load=function(){return this._fileURL?this.requestURL():AE.error("no file URL were specified")},b.prototype.requestURL=function(){var a=this;return c(this._fileURL,function(b){return AE.FileSystem.getInstance().writeFile(a.guid,b,function(){return a._onSuccess(a._filepath)})})},b}(AE.Object),AE.Assets.Manager=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.assetsOrigin=[],b.prototype.assets={},b.prototype.register=function(a){var b,c,d;d=[];for(b in a)c=a[b],this.assetsOrigin.push({name:b,path:c}),d.push(this.assets[b]=null);return d},b.prototype.load=function(a,b){var c,d,e,f,g;this.remaining=this.assetsOrigin.length,f=this.assetsOrigin,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(this.loadSingleAsset(c,a,b));return g},b.prototype.loadSingleAsset=function(a,b,c){var d,e=this;return d=this.createURLLoader(a.path,function(d){console.log(""+a.name+" ready"),e.assets[a.name]=d,e.remaining=e.remaining-1,c();if(e.remaining===0)return b()}),d.load()},b.prototype.get=function(a){return this.assets[a]===null?AE.log(""+a+" not loaded yet"):this.assets[a]===void 0?AE.error(""+a+" not referenced"):this.assets[a]},b.prototype.createURLLoader=function(a,b){var c;return c=new AE.Assets.URLLoader(a,b),c},b}(AE.Singleton),self.document&&(e=document.getElementsByTagName("script"),d=e[e.length-1],b=d.src.replace(/\/script\.js$/,"/")),AE.MVC.Controller=function(){function a(){}return a.prototype.init=function(){},a}(),AE.MVC.Model=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype._propertyChangedEvent=null,b.prototype.init=function(){return this._propertyChangedEvent=new AE.Event(this)},b.prototype.get=function(a){return this[a]},b.prototype.set=function(a,b){return this[a]=b,this.notifyPropertyChanged(a)},b.prototype.notifyPropertyChanged=function(a){return this._propertyChangedEvent.notify({property:a})},b}(AE.Object),AE.MVC.View=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.init=function(){},b}(AE.Object),AE.MessageBox=function(){function a(){}return a.prototype._messages=null,a.prototype.post=function(a,b){return this._messages[a].push(b)},a.prototype.get=function(a){return this._messages[a]},a.prototype.flush=function(a){return this._messages[a]=[]},a.prototype.onMessage=function(a){return self.postMessage("hello from MessageBox !")},a}(),AE.Workers.Manager=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return h(c,a),c.prototype._workers=[],c.prototype._libBlob=null,c.prototype.createFromScript=function(a){var b,c,d;return b=new Blob([a],{type:"application/javascript"}),c=URL.createObjectURL(b),d=new Worker(c),this._workers.push(d),URL.revokeObjectURL(c),d},c.prototype.createWithMessagingSystem=function(){var a,c,d,e;return d="    self.requestFileSystemSync =       self.webkitRequestFileSystemSync || self.requestFileSystemSync;\n    self.resolveLocalFileSystemURL =       self.webkitResolveLocalFileSystemURL || self.resolveLocalFileSystemURL;\n    self.onmessage = function(e) {\n      var data = e.data;\n      switch (data.cmd) {\n        case 'start':\n          self.postMessage('WORKER STARTED: ' + data.msg);\n          break;\n        case 'stop':\n          self.postMessage('WORKER STOPPED: ' + data.msg +'.            (buttons will no longer work)');\n          self.close();\n          break;\n        case 'loadContext':\n          eval(data.msg);\n        case 'loadFile':\n          try{\n            self.resolveLocalFileSystemURL(data.msg, function(fileEntry) {\n              console.log(fileEntry.name);\n            });\n          } catch (e) {\n            console.error(e);\n          }\n          break;\n        case 'importScript':\n          console.log(data.msg);\n          importScripts(data.msg);\n          self;          break;\n        case 'onmessage':\n          self.onmessage = data.msg;\n          break;\n        default:\n          self.postMessage('Unknown command: ' + data.msg);\n        };\n    };\n    ",e=this.createFromScript(d),e.onmessage=this._onWorkerMessage,c=new AE.MessageBox,a=AE.Assets.Manager.getInstance().createURLLoader(b,function(a){return AE.FileSystem.getInstance().readFile(a,function(a){return e.postMessage({cmd:"loadContext",msg:a})})}),a.load()},c.prototype._onWorkerMessage=function(a){return console.log(a.data)},c.prototype.sendMessageTo=function(a,b){return this._workers[a].postMessage(b)},c}(AE.Singleton),AE.Game=Game,Game.Engine=function(a){function b(a){AE.Config.getInstance().setConfig(a),this.MessageBox=this.MessageBox}return h(b,a),b.prototype._phasesManager=null,b.prototype._messageBox=null,b.property("PhasesManager",{get:function(){return this._phasesManager||(this._phasesManager=new AE.States.GamePhasesManager),this._phasesManager}}),b.property("MessageBox",{get:function(){return this._messageBox||(this._messageBox=AE.Workers.Manager.getInstance().createWithMessagingSystem()),this._messageBox}}),b}(AE.Engine),AE.Audio=Audio,Audio.Engine=function(a){function b(){AE.log("AE.Audio: start")}return h(b,a),b.prototype.context=null,b.prototype.effectsSystems={},b.prototype.musicSystems={},b.prototype.createEffectsSubSystem=function(a,b){return this.effectsSystems[a]=new AE.Audio.EffectsSubSystem(b),this.effectsSystems[a]},b.prototype.createMusicSubSystem=function(a,b){return this.musicSystems[a]=new AE.Audio.MusicSubSystem(b),this.musicSystems[a]},b}(AE.Engine),Audio.Effect=function(a){function b(a,b,c){this.name=a,this.context=b,this.callback=c}return h(b,a),b.prototype.name=null,b.prototype.context=null,b.prototype.buffer=null,b.prototype.loaded=!1,b.prototype.prepare=function(a){var b,c=this;return b=AE.Assets.Manager.getInstance().get(this.name),AE.FileSystem.getInstance().readBuffer(b,function(b){return c.context.decodeAudioData(b,function(b){c.buffer=b,c.loaded=!0;if(a)return a()})})},b.prototype.fire=function(){var a;return a=this.context.createBufferSource(),a.buffer=this.buffer,a.connect(this.context.destination),a.start(0)},b}(AE.Object),Audio.EffectsSubSystem=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.sounds={},b.prototype.context=null,b.prototype.length=0,b.prototype.loadMap=function(a){var b,c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],this.sounds[b]=new AE.Audio.Effect(b,this.context),e.push(this.length++);return e},b.prototype.fire=function(a){return this.sounds[a]?this.sounds[a].fire():onError()},b.prototype.prepare=function(a){var b,c,d,e,f,g;d=this.length,c=function(){d-=1;if(d===0)return a()}.bind(this,d,a),f=this.sounds,g=[];for(b in f)e=f[b],g.push(e.prepare(c));return g},b}(Audio.SubSystem),Audio.Music=function(a){function b(a,b,c){this.name=a,this.context=b,this.callback=c}return h(b,a),b.prototype.name=null,b.prototype.context=null,b.prototype.buffer=null,b.prototype.loaded=!1,b.prototype.prepare=function(a){var b,c=this;return b=AE.Assets.Manager.getInstance().get(this.name),AE.FileSystem.getInstance().readBuffer(b,function(b){return c.context.decodeAudioData(b,function(b){c.buffer=b,c.loaded=!0;if(a)return a()})})},b.prototype.play=function(){var a;return this.loaded===!0?(a=this.context.createBufferSource(),a.buffer=this.buffer,a.connect(this.context.destination),a.start(0)):AE.error("[MUSIC] not loaded yet: "+this.name)},b}(AE.Object),Audio.MusicSubSystem=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.sounds={},b.prototype.context=null,b.prototype.length=0,b.prototype.loadMap=function(a){var b,c,d,e;e=[];for(c=0,d=a.length;c<d;c++)b=a[c],this.sounds[b]=new AE.Audio.Music(b,this.context),e.push(this.length++);return e},b.prototype.play=function(a){return this.sounds[a]?this.sounds[a].play():onError()},b.prototype.prepare=function(a){var b,c,d,e,f,g;d=this.length,c=function(){d-=1;if(d===0)return a()}.bind(this,d,a),f=this.sounds,g=[];for(b in f)e=f[b],g.push(e.prepare(c));return g},b}(Audio.SubSystem)})).call(this)